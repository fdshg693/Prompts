# プロンプト管理パッケージ - PLAN.md

## 目的/概要
Markdownベースのプロンプトテンプレートを、YAMLフロントマターによる変数セット・抽出指定・マージ設定で管理し、CLIからバリエーション生成とマージを行うPythonパッケージ。生成物は変数を埋め込んだMarkdownのみを出力する。

## 想定利用フロー
1. テンプレートMDを`---`で囲ったYAMLフロントマター付きで作成
2. フロントマターに複数の変数セットと抽出可能対象(XML)を定義（共にオプション）
3. `prompt_manage_config.yaml`で出力ファイル名・テンプレート参照・変数セットを指定（相対パスは設定ファイルからの相対として解決）
4. CLIを実行し、変数代入と必要に応じたマージを処理（マージはプレースホルダ{{ template_n }}のみで制御）
5. 設定ファイルが置かれたディレクトリを基準に各エントリの`output_path`で指定した出力先ディレクトリを生成し、指定ファイル名でMarkdownを出力

## 機能要件

### プロンプトテンプレート取扱い
- Markdown形式でテンプレートを作成
- フロントマターは`---`で囲うYAML形式のみを使用
- 変数は`{{ variable_name }}`形式で埋め込む
- 変数セットはフロントマター内にのみ定義し、テンプレートごとに複数セットを許容
- 変数セットはテンプレート内でユニークであること、デフォルト値は持たず全項目必須
- 変数セットの組み合わせ生成や結合は行わず、指定された単一セットで展開

### YAMLメタデータ管理
- 先頭フロントマターの解析とバリデーションを実施
- 変数セットはフロントマターでのみ宣言（他所からの継承やデフォルトなし）
- 抽出対象（XMLコードブロック）はフロントマターの`extractions`のような配列に`- name: block_1, type: xml`形式で指定
- 変数セット名および抽出ターゲット名はテンプレート内で一意であること

### 変数セット/バリエーション生成
- 名前付き変数セットを選択して単一展開する（セット間の組み合わせは不可）
- すべての変数が必須であるため、欠損があればエラーで停止
- 展開後のファイル名は設定ファイルの`file_name`をそのまま採用

### コードブロック抽出（XMLコードフェンスのみ）
- 抽出対象は属性付きXMLコードフェンス（例: ```xml name="config"）に限定
- JSON等その他フォーマットは対象外
- 同一テンプレート内で同じ名前・形式のXMLブロックが複数出現する場合はエラー扱い
- 抽出対象はフロントマターで指定した`name`/`type: xml`に合致するブロックのみ

### プロンプトマージテンプレート
- マージは`{{ template_1 }}`のようなプレースホルダ置換のみで制御
- 受け入れるテンプレート数の上限をマージテンプレートのフロントマターで明示
- 条件分岐やPython関数によるマージ拡張は行わない
- マージテンプレート自身もフロントマターで変数セット・抽出指定を管理

## 設定ファイル要件

### prompt_manage_config.yaml
- **配置/出力ディレクトリ**: 設定ファイルが置かれたディレクトリを基準とし、各エントリの`output_path`で指定されたディレクトリを生成（既存でも上書き確認なし）
- **パス解決**: テンプレートやマージテンプレートのパスは設定ファイルからの相対パス
- **ファイル命名**: 実際の出力ファイル名は各エントリの`file_name`をそのまま用いる（テンプレート名からの派生はしない）
- **バリデーション**: Pydanticモデルで厳格に検証し、エラー時は処理を即時停止

### デフォルトディレクトリとパス解決
- パッケージは仮想環境内にインストールされていることを前提とする
- `Path(__file__).parent`から親ディレクトリを遡って最初に見つかった`pyproject.toml`を採用する（同一ワークスペース内の複数やモノレポ構成でも警告しない。インストール済みパッケージ自身の`pyproject`は探索対象外）
- `pyproject.toml`の`[tool.prompt_manage]`で`templates_dir`/`merge_templates_dir`を必須指定し、いずれもワークスペースルートからの相対パスとする。`pyproject.toml`が見つからない、あるいは`[tool.prompt_manage]`未定義の場合はエラー扱いとし、パッケージレベルのデフォルトは持たない
- `prompt_manage_config.yaml`内のテンプレート／マージテンプレートのパスは、上記デフォルトディレクトリを基準とした相対パスとして解決し、絶対パス指定は禁止する
- **出力先は`prompt_manage_config.yaml`内の各エントリの`output_path`で相対パスとして必ず指定する必要があります**（`output_path`は設定ファイルが置かれたディレクトリを基準に解決）。
- CLIオプションでデフォルトディレクトリ（`templates_dir`/`merge_templates_dir`）を上書きでき、指定されないものは`pyproject.toml`の値をそのまま採用する。オプション経由のパスは現在の作業ディレクトリを基準に解釈し、`..`によるワークスペース外参照も許容する
- 設定の優先順位はCLIオプション > `pyproject.toml`とし、パッケージデフォルトのレイヤーは存在しない
- パッケージは`uv`によるインストールを前提とし、`pip`へのフォールバックは考慮しない

#### スキーマの考え方
- 単一生成の場合：`file_name`（出力ファイル名）、`output_path`（設定ファイルからの相対出力ディレクトリ）、`template`（テンプレートパス）、`variables_set`（テンプレート内セット名）、必要に応じて`template`に`template_name.md#block_1`のような抽出ターゲット指定を許容
- マージ生成の場合：`output_path`（出力ディレクトリ）、`file_name`、`merge_template`（マージ用テンプレートパス）、`templates`配列内で各要素に`file_name`と`variables_set`を指定（マージに供する個々のテンプレートを指す）

#### 設定例（マージなし）
```yaml
outputs:
  - file_name: intro-ja.md
    output_path: ./outputs
    template: templates/intro.md
    variables_set: base_ja

  - file_name: system-ja.md
    output_path: ./outputs/system
    template: templates/system.md#block_1
    variables_set: sys_ja
```

#### 設定例（マージあり）
```yaml
outputs:
  - file_name: merged-guide.md
    output_path: ./outputs
    merge_template: templates/merge.md
    templates:
      - file_name: templates/part_a.md
        variables_set: ja_a
      - file_name: templates/part_b.md
        variables_set: ja_b
```

## 入出力

### 入力
- **テンプレート**: フロントマター付きMarkdown（変数セットと抽出指定を内包）
- **設定ファイル**: 出力ディレクトリごとの`prompt_manage_config.yaml`（相対パス指定）

### 出力
- **生成プロンプトファイル**: 変数代入済みMarkdownのみ（ファイル名は`file_name`を厳守）

### CLI利用・探索ルール
- CLI引数には`prompt_manage_config.yaml`ファイルパスだけでなく、`./`や`./sub/`のようなディレクトリを指定可能。ディレクトリを渡した場合、そのディレクトリを基準に設定ファイルを探索して実行対象とする。
- ディレクトリ配下の`prompt_manage_config.yaml`を再帰的に探索し一括実行するかを切り替えるCLIフラグを提供（再帰OFF時は指定ディレクトリ直下のみ、ON時は配下すべてを探索し見つかった設定を順次実行）。
- 各`prompt_manage_config.yaml`内`outputs[*].output_path`は**常に当該設定ファイルの配置ディレクトリからの相対パス**として解決する（`[tool.prompt_manage].output_dir`は不使用）。

## 非機能/その他

### 実装形態
- **CLI専用**: コマンドラインツールとして提供（ライブラリ利用やハイブリッド形態は想定しない）
- **コア技術**: Pydanticで設定バリデーション、loguruでロギング、ドメイン固有のカスタム例外でエラー整形
- **フック**: Python関数によるマージや抽出のフック提供は行わない

### 環境・バージョン
- **Python Version**: TBD（後日確定）
- **依存パッケージ**: Pydantic、loguru（ほか必要最小限）

### 拡張性・保守性
- フロントマターと設定ファイルのスキーマを固定し、テスト可能なCLIとして維持
- Pydanticバリデーションを中心に堅牢性を確保
- ログと例外メッセージでトラブルシュートを容易化
