# 段階的実行計画（改訂版 PHASED_TASKS）

`PLAN.md` / `FILE_STRUCTURE.md` / `FILE_STRUCTURE_OVERVIEW.md` を唯一の基準とし、スコープを固定したまま段階的に設計・実装を進める。各フェーズ終了時にスコープ逸脱と未決事項を棚卸しし、次フェーズに持ち越す。

## フェーズ0: コンテキスト同期とスコープ固定
- 目標: 3文書の前提を揃え、追加要求は「持ち越しリスト」に隔離する運用を決める。
- 成果物: スコープ確認メモ（対象/非対象、持ち越しリスト、参照リンク）。
- 受け入れ条件: スコープ内外が明文化され、以後の判断基準として参照できること。

## フェーズ1: 要件トレースとギャップ洗い出し
- 目標: 単一生成/マージ/抽出/パス解決/CLIの各要求を`PLAN.md`と`FILE_STRUCTURE.md`の責務にマッピングし、漏れと矛盾を列挙。
- 成果物: トレース表（機能→根拠行→未決/質問）、優先度付きギャップリスト。
- 受け入れ条件: 主要ユースケースがすべてトレースされ、未決事項が明記されていること。

## フェーズ2: スキーマ & バリデーション確定（設定+フロントマター）
- 目標: Pydanticモデルと追加バリデーションの項目・制約を確定。
- 成果物: 項目一覧（必須/型/制約/エラーメッセージ方針）。主要項目例: `outputs[*].file_name`・`outputs[*].output_path`（設定ファイル基準の相対必須、絶対禁止）、`template`/`merge_template`（デフォルトディレクトリ基準相対、絶対禁止）、`variables_set` 必須、`templates[*].variables_set` 必須、`max_templates` 正整数、フロントマター内の `variables_sets`/`extractions` の名前一意性。
- 受け入れ条件: `FILE_STRUCTURE_OVERVIEW.md`の優先順位（CLI > pyproject.toml > デフォルトなし）を踏襲し、禁止事項（絶対パス・デフォルトディレクトリ未定義時はエラー）が明文化されていること。

## フェーズ3: テンプレート解析・展開・抽出フロー設計
- 目標: ロード→フロントマター解析→変数セット選択→テンプレート展開→抽出検証のシーケンスとエラー条件を確定。
- 成果物: フロー図または手順書、エラー基準（変数欠損、未定義セット、抽出ターゲット不一致・重複、XML以外の抽出禁止、コードフェンス名の重複エラー）。
- 受け入れ条件: 単一テンプレート処理の入口・出口・例外が明示され、テストケース化できる粒度で記述されていること。

## フェーズ4: マージフローとガードレール
- 目標: `merge_template`のフロントマター検証、`max_templates`超過時の失敗条件、`{{ template_n }}`置換手順、構成テンプレート展開順の扱いを設計。
- 成果物: マージ処理手順、入力検証チェックリスト（欠損/過剰/順序不一致時の挙動）。
- 受け入れ条件: 置換対象のインデックス規則とエラー時のメッセージ方針が明文化され、テスト観点に落とし込めること。

## フェーズ5: パス解決・CLI統合
- 目標: CLIオプション・`pyproject.toml`・設定ファイルの優先順位を実装に写経し、設定探索（単一/再帰）と出力ディレクトリ解決を統合する。
- 成果物: CLIフロー（引数→設定探索→パス解決→処理委譲）、エラー時の終了コード方針、ログ粒度の草案。
- 受け入れ条件: 優先順位（CLI > pyproject.toml / デフォルトなし）が処理順として示され、`output_path`の解決基準が一貫していること。

## フェーズ6: テスト設計とサンプル作成
- 目標: 主要ハッピーパス（単一生成/マージ/抽出）とエラーパス（絶対パス指定・未定義`variables_set`・`max_templates`超過・抽出名重複など）のテストケースを列挙し、最小限のテンプレート/設定サンプルを用意。
- 成果物: テスト観点リスト、サンプルテンプレートと`prompt_manage_config.yaml`のペア。
- 受け入れ条件: 各フェーズの受け入れ条件に紐づくテスト観点が網羅され、再利用可能なサンプルが揃っていること。

## フェーズ7: ドキュメント & 運用準備
- 目標: CLI利用手順、パス解決の注意点、よくあるエラーと対処をREADME/NOTE化。
- 成果物: README追記案、運用チェックリスト（実行前チェック: pyproject有無・デフォルトディレクトリ設定・絶対パス混入確認）。
- 受け入れ条件: 想定利用フローをなぞれる手順が提示され、運用時の落とし穴が列挙されていること。
