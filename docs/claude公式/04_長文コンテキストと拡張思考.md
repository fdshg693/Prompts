# 長文コンテキストと拡張思考

## 概要

このドキュメントでは、Claudeの高度な機能である「長文コンテキスト処理」と「拡張思考（Extended Thinking）」の活用方法を学びます。Claude 3モデルは200Kトークンという広大なコンテキストウィンドウを持ち、複雑でデータ量の多いタスクに対応できます。また、拡張思考モードを使用することで、難しい問題に対してステップバイステップで思考を深め、パフォーマンスを向上させることができます。

**学べる内容:**
1. **長文コンテキストの活用** - 20万トークンを効果的に使う方法
2. **拡張思考の戦略** - 複雑な問題解決のための思考プロセスの最適化

---

## 目次

- 長文コンテキストのヒント（Long Context Tips）
  - 概要と特徴
  - なぜ長文コンテキストを使うのか
  - 使い方とベストプラクティス
  - 具体例
  - ポイント・注意事項
- 拡張思考のヒント（Extended Thinking Tips）
  - 概要と特徴
  - なぜ拡張思考を使うのか
  - 使い方とプロンプティング技術
  - 具体例
  - ポイント・注意事項

---

## 長文コンテキストのヒント（Long Context Tips）

### 概要と特徴

Claude 3モデルは**200,000トークン（約20万トークン）**という非常に大きなコンテキストウィンドウを持っています。これは、一度に大量の文書やデータを処理できることを意味します。

**主な特徴:**
- **大容量**: 複数の長文文書を同時に扱える
- **複雑なタスク対応**: データが豊富な複雑なタスクに適している
- **構造化サポート**: XMLタグによる整理で精度が向上

### なぜ長文コンテキストを使うのか

長文コンテキストを効果的に活用することで、以下のようなメリットがあります：

1. **複数文書の同時分析**: 契約書、研究論文、レポートなどを一度に比較・分析
2. **データ量の多いタスク**: 大量のログ、顧客フィードバック、調査データの処理
3. **コンテキスト保持**: 長い会話や継続的なタスクで情報を維持
4. **精度向上**: テストでは最大30%の応答品質改善が確認されている（特に複雑な多文書入力の場合）

### 使い方とベストプラクティス

#### 1. 長文データは上部に配置する

**最も重要なルール:**
長文の文書や入力データ（約20K+トークン）は、**プロンプトの上部（先頭）**に配置してください。クエリ（質問）、指示、例示は**その後**に配置します。

**推奨される構造:**
```xml
<documents>
  [長文データ・文書をここに配置]
</documents>

<instructions>
  [指示やタスクの説明]
</instructions>

<examples>
  [例示（必要な場合）]
</examples>

[質問やクエリを最後に配置]
```

**理由:**
- クエリを最後に配置することで、複雑な多文書入力において応答品質が最大30%向上
- Claudeがデータ全体を読み込んでから、具体的なタスクに取り組める

#### 2. XMLタグで文書内容とメタデータを構造化する

**複数の文書を扱う場合:**
各文書を`<document>`タグでラップし、`<document_content>`と`<source>`（およびその他のメタデータ）のサブタグを使用します。

**基本パターン:**
```xml
<document>
  <source>契約書A.pdf</source>
  <document_content>
    [文書の内容]
  </document_content>
</document>

<document>
  <source>契約書B.pdf</source>
  <document_content>
    [文書の内容]
  </document_content>
</document>
```

**メリット:**
- 文書の区別が明確になる
- メタデータの管理が容易
- Claudeの解析精度が向上

#### 3. 引用を基にした回答を求める

**長文文書のタスクでは:**
Claudeに、**まず文書から関連部分を引用させてから**、タスクを実行させることで精度が向上します。

**プロンプト例:**
```
以下の文書から、顧客の主な懸念事項を特定してください。
回答する前に、関連する部分を文書から直接引用してください。
その後、分析結果を提供してください。
```

**理由:**
- 文書全体の「ノイズ」を取り除く助けになる
- 根拠が明確になり、正確性が向上
- ハルシネーション（誤った情報生成）のリスクが低減

### 具体例

#### 例1: 複数の研究論文を比較分析

```xml
<document>
  <source>Smith_2023_AI_Ethics.pdf</source>
  <document_content>
[論文1の全文: 約15,000トークン]
  </document_content>
</document>

<document>
  <source>Johnson_2023_Machine_Learning_Bias.pdf</source>
  <document_content>
[論文2の全文: 約18,000トークン]
  </document_content>
</document>

<document>
  <source>Lee_2023_Algorithmic_Fairness.pdf</source>
  <document_content>
[論文3の全文: 約20,000トークン]
  </document_content>
</document>

<instructions>
上記の3つの論文を比較し、以下を分析してください：

1. 各論文のAI倫理に関する主要な論点
2. 共通のテーマと相違点
3. 各著者が提案する解決策

各ポイントについて、関連する引用を含めてください。
</instructions>
```

#### 例2: 顧客フィードバックの分析

```xml
<customer_feedback>
[5,000件の顧客レビュー: 約30,000トークン]
</customer_feedback>

<instructions>
上記の顧客フィードバックを分析し、以下を特定してください：

1. 最も頻繁に言及される問題点（トップ5）
2. 顧客が最も評価している機能
3. 改善の優先順位に関する推奨事項

各項目について、具体的な顧客の声を引用してください。
</instructions>
```

#### 例3: 法的文書のリスク分析

```xml
<document>
  <source>Master_Service_Agreement.docx</source>
  <document_type>契約書</document_type>
  <date>2024-01-15</date>
  <document_content>
[マスターサービス契約書: 約25,000トークン]
  </document_content>
</document>

<instructions>
この契約書を詳細に分析し、リスクとなる可能性のある条項を特定してください。

各リスク項目について：
1. まず、該当する条項を直接引用する
2. リスクの種類と程度を説明する
3. 推奨される対応策を提案する
</instructions>
```

### ポイント・注意事項

✅ **実践すべきこと:**
- 長文データ（20K+トークン）は必ず上部に配置
- 質問やクエリは最後に配置
- XMLタグで文書を構造化
- 引用を基にした回答を求める
- メタデータ（ソース、日付など）を含める

❌ **避けるべきこと:**
- 質問を先に書いて、データを後に配置する
- 複数文書を区別なく混在させる
- 文書の構造化をせずに大量のテキストを渡す
- 引用なしで分析だけを求める

**パフォーマンスへの影響:**
- 適切な配置とクエリの位置で、応答品質が最大30%向上
- XMLタグによる構造化で、解析精度が大幅に改善
- 引用の要求により、根拠のある正確な回答が得られる

---

## 拡張思考のヒント（Extended Thinking Tips）

### 概要と特徴

**拡張思考（Extended Thinking）**は、Claudeが複雑な問題をステップバイステップで考え、パフォーマンスを向上させる機能です。通常のモードに比べ、より深く考えることで難しいタスクの成功率が高まります。

**主な特徴:**
- **思考プロセスの可視化**: Claudeがどう考えているかを確認できる
- **思考トークンバジェット**: 思考に使用するトークン数を制御可能（最小1,024トークン）
- **段階的な問題解決**: 複雑なタスクを自然に分解して処理
- **エラー検出と修正**: 自己チェック機能により精度が向上

### なぜ拡張思考を使うのか

拡張思考モードは、以下のような場合に特に効果的です：

1. **複雑な問題解決**: 数学的推論、論理パズル、多段階の分析
2. **コード生成とデバッグ**: テストケースを考慮した堅牢なコード作成
3. **創造的なコンテンツ生成**: 詳細な記事、レポート、データセット作成
4. **精度が重要なタスク**: 間違いが許されない重要な意思決定サポート
5. **指示遵守の向上**: 複雑な指示を正確に理解し実行

**パフォーマンス改善:**
- 指示遵守能力が大幅に向上
- エラー率の低減
- より論理的で一貫した出力

### 技術的考慮事項

拡張思考を使用する前に、以下の技術的な制約を理解しておく必要があります：

#### 思考トークンバジェット

- **最小バジェット**: 1,024トークン
- **推奨アプローチ**: 最小値から始めて、必要に応じて段階的に増やす
- **大規模バジェット（32K+）**: バッチ処理の使用を推奨（ネットワークタイムアウトを回避）

#### 言語サポート

- **最適パフォーマンス**: 英語での思考プロセス
- **出力言語**: Claudeがサポートする任意の言語で最終出力可能

#### 最小バジェット未満の場合

思考が1,024トークン未満で十分な場合は、標準モードで**Chain-of-Thought（CoT）プロンプティング**を使用することを推奨：

```xml
<thinking>
[ここに思考プロセスを記述]
</thinking>
```

### 使い方とプロンプティング技術

#### 1. まず一般的な指示から始め、必要に応じて詳細化

**重要な原則:**
Claudeは、ステップバイステップの細かい指示よりも、**高レベルで一般的な指示**の方が優れたパフォーマンスを発揮することが多い。

**❌ 避けるべき例（過度に細かい指示）:**
```
この数学の問題を解いてください。以下の手順で進めてください：
1. まず、変数を特定する
2. 次に、方程式を立てる
3. その後、xを解く
4. 最後に、答えを検証する
```

**✅ 推奨される例（一般的で自由度の高い指示）:**
```
この数学の問題について、徹底的かつ詳細に考えてください。
複数のアプローチを検討し、完全な推論を示してください。
最初のアプローチがうまくいかない場合は、別の方法を試してください。
```

**理由:**
- Claudeの創造性が問題へのアプローチにおいて、人間が規定する手順を超える可能性がある
- モデルが最適な思考プロセスを自ら選択できる

**注意:** 
複雑な構造化された実行ステップが必要な場合、Claudeはそれらにも効果的に従うことができます。最新モデルは、以前のバージョンよりも長く複雑な指示リストを処理できます。

**推奨ワークフロー:**
1. 一般的な指示から始める
2. Claudeの思考出力を読む
3. 必要に応じて、より具体的な指示で調整する

#### 2. マルチショットプロンプティングとの併用

**拡張思考とマルチショット（例示）を組み合わせる:**
Claudeに問題の考え方の例を示すことで、同様の推論パターンを拡張思考ブロック内で使用するようになります。

**基本的なアプローチ:**
XMLタグ（`<thinking>`や`<scratchpad>`など）を使って、例示の中で拡張思考の標準的なパターンを示します。

**例: 数学問題の解き方を例示**

```
数学の問題を解く方法を示します。その後、同様の問題を解いてください。

問題1: 80の15%はいくらですか？

<thinking>
80の15%を求めるには：
1. 15%を小数に変換: 15% = 0.15
2. 掛け算: 0.15 × 80 = 12
</thinking>

答えは12です。

では、この問題を解いてください：
問題2: 240の35%はいくらですか？
```

**注意:**
Claudeに自由に考えさせた方が良い結果が得られる可能性もあります。例示はガイダンスとして使用し、必ずしも厳密に従わせる必要はありません。

#### 3. 指示遵守を最大化する

拡張思考を有効にすると、Claudeの指示遵守能力が大幅に向上します。

**モデルの典型的な動作:**
1. 拡張思考ブロック内で指示について推論
2. レスポンス内でそれらの指示を実行

**指示遵守を最大化するコツ:**
- **明確で具体的に**: 求めることを正確に記述
- **番号付きステップ**: 複雑な指示は段階的に分解
- **十分なバジェット**: 指示を完全に処理できる思考バジェットを確保

**例: 複雑な指示の構造化**

```
以下のタスクを実行してください：

1. データセット内の異常値を特定する
2. 各異常値について、統計的根拠を示す
3. 異常値を除外した場合の影響を分析する
4. 推奨アクションをまとめる

各ステップを方法論的に進め、思考プロセスを示してください。
```

#### 4. 拡張思考を使ったデバッグと動作調整

**思考出力の活用:**
Claudeの思考出力を読むことで、ロジックをデバッグできます（ただし、完全に信頼できるわけではありません）。

**ベストプラクティス:**

✅ **推奨される方法:**
- 思考出力を読んで理解を深める
- 新しいプロンプトで指示を調整する

❌ **推奨されない方法:**
- Claudeの拡張思考を`user`テキストブロックに戻して渡す（パフォーマンスが低下する可能性）
- 拡張思考のプリフィル（明示的に許可されていない）
- モデルの出力テキストを手動で変更する（モデルの混乱を招く）

**注意:**
拡張思考がオフの場合、標準の`assistant`レスポンステキストのプリフィルは可能です。

**思考の繰り返し防止:**
Claudeが拡張思考を出力テキストで繰り返すことがあります。クリーンな回答が必要な場合：

```
拡張思考の内容を繰り返さないでください。
答えのみを出力してください。
```

#### 5. 長文出力と詳細な思考の最適化

**データセット生成やコンテンツ生成のヒント:**

**詳細なデータセットを生成:**
```
非常に詳細な表を作成してください。「...」の部分は以下の内容で埋めてください：
[具体的な指示]
```

**長文コンテンツ生成のコツ:**
- **思考バジェットと出力長の両方を増やす**: 明示的に長い出力を要求
- **詳細なアウトラインを使用（20,000語以上の場合）**:
  1. 段落レベルまでの詳細なアウトラインを単語数とともに要求
  2. Claudeに各段落をアウトラインにインデックス付けさせる
  3. 指定された単語数を維持させる

**重要:** 
トークン数を増やすこと自体を目的にしないでください。小さな思考バジェットから始めて、ユースケースに最適な設定を見つけるために必要に応じて増やしてください。

**拡張思考が優れているユースケース例:**
- 複雑な数学的推論
- 多段階のコード生成とテスト
- 詳細な調査レポート作成
- 大規模なデータセット生成

#### 6. 作業の反映とチェックによる一貫性とエラー処理の改善

**自己チェック機能の活用:**
シンプルな自然言語プロンプティングで一貫性を向上させ、エラーを削減できます。

**戦略:**
1. タスクを完了する前にシンプルなテストで検証するよう求める
2. 前のステップが期待される結果を達成したかを分析させる
3. コーディングタスクでは、思考内でテストケースを実行させる

**例: 関数の検証**

```
数値の階乗を計算する関数を書いてください。
完了する前に、以下のテストケースで解決策を検証してください：
- n=0
- n=1
- n=5
- n=10

問題が見つかった場合は修正してください。
```

**メリット:**
- エラーの早期発見と修正
- 一貫性の向上
- 堅牢なコード生成

### 具体例

#### 例1: 複雑な数学問題の解決

```
以下の問題を解いてください。複数のアプローチを検討し、詳細な推論を示してください。

問題: ある会社の売上は毎年15%ずつ成長しています。現在の売上が500万円の場合、
5年後の売上はいくらになりますか？また、累積売上の合計はいくらですか？

計算過程を詳しく示し、最終的な答えを検証してください。
```

**期待される動作:**
- Claudeは拡張思考ブロック内で複数の計算方法を検討
- 複利計算の公式を適用
- 各年の売上を計算
- 累積合計を算出
- 最終的に答えを検証

#### 例2: コード生成とデバッグ

```
Pythonで、与えられたリストから重複を削除し、元の順序を保持する関数を作成してください。

要件：
1. 関数名は remove_duplicates
2. 元のリストを変更しない
3. 空リストにも対応

完了後、以下のテストケースで検証してください：
- [1, 2, 3, 2, 1] → [1, 2, 3]
- [] → []
- [5, 5, 5] → [5]
- [1, 2, 3, 4, 5] → [1, 2, 3, 4, 5]

問題があれば修正してください。
```

**期待される動作:**
- 拡張思考で複数の実装方法を検討（set, dict.fromkeys, リスト内包表記など）
- 各アプローチの長所・短所を評価
- 最適な実装を選択
- テストケースを実行
- エラーがあれば修正

#### 例3: 詳細なレポート生成

```
AIの倫理的課題について、包括的なレポートを作成してください。

要件：
- 最低5つの主要な倫理的課題を取り上げる
- 各課題について、具体例と解決策を含める
- 学術的な根拠を示す
- 結論と今後の展望を含める

徹底的に考え、詳細で構造化されたレポートを作成してください。
```

**期待される動作:**
- 拡張思考で課題を体系的に整理
- 各課題の重要性を評価
- 論理的な構成を計画
- 詳細な内容を執筆
- 一貫性と完全性をチェック

#### 例4: マルチショットプロンプティング with 拡張思考

```
顧客の問い合わせに対する返信方法を示します。その後、同様に返信してください。

例:
問い合わせ: 注文した商品がまだ届きません。

<thinking>
1. 顧客の懸念を理解: 配送の遅延
2. 必要な情報: 注文番号、配送状況の確認
3. トーン: 謝罪と解決策の提示
4. 次のステップ: 具体的なアクション
</thinking>

返信:
ご連絡ありがとうございます。ご注文の商品がまだ届いていないとのこと、
大変申し訳ございません。

お手数ですが、注文番号をお知らせいただけますでしょうか。
すぐに配送状況を確認し、詳細をご報告させていただきます。

---

では、以下の問い合わせに返信してください:
問い合わせ: 購入した製品が初期不良のようです。交換は可能ですか？
```

**期待される動作:**
- 例示された思考パターンを学習
- 同様のアプローチで新しい問い合わせを処理
- 拡張思考ブロック内で適切な対応を検討
- 丁寧で実用的な返信を生成

### ポイント・注意事項

✅ **実践すべきこと:**
- 一般的で高レベルの指示から始める
- 最小思考バジェット（1,024トークン）から開始し、必要に応じて増やす
- Claudeの思考出力を読んで理解を深める
- 自己検証を促す指示を含める
- 英語での思考プロセス（最適パフォーマンス）
- マルチショットプロンプティングと組み合わせる

❌ **避けるべきこと:**
- 最初から過度に細かいステップバイステップの指示
- 思考出力を`user`ブロックに戻して渡す
- 拡張思考のプリフィル（許可されていない）
- トークン数を増やすこと自体を目的とする
- 32K以上の思考バジェットを通常のAPIで使用（バッチ処理を推奨）

**パフォーマンス向上のポイント:**
- **指示遵守の大幅な改善**: 拡張思考モードで複雑な指示を正確に実行
- **エラー率の低減**: 自己チェック機能により精度が向上
- **創造性と問題解決**: Claudeが最適なアプローチを自ら選択

**思考バジェットの目安:**
- **1,024トークン**: 基本的な問題解決、シンプルなコード生成
- **4,096〜8,192トークン**: 中程度の複雑さの分析、詳細なコード
- **16,000トークン以上**: 非常に複雑な推論、大規模なコンテンツ生成
- **32,000トークン以上**: バッチ処理を推奨（ネットワークタイムアウト対策）

**いつ拡張思考を使うべきか:**
- 複雑な論理的推論が必要な場合
- 多段階の問題解決
- 高い精度が求められるタスク
- コードの生成とデバッグ
- 詳細なコンテンツやデータセットの作成

**いつ標準モードを使うべきか:**
- シンプルなタスク
- 1,024トークン未満の思考で十分な場合（CoTプロンプティングを使用）
- 速度が重視される場合
- コストを最小限に抑えたい場合

---

## まとめ

このドキュメントでは、Claudeの2つの高度な機能を学びました：

**1. 長文コンテキスト（200Kトークン）:**
- 長文データは上部に配置し、クエリは最後に
- XMLタグで複数文書を構造化
- 引用を基にした回答で精度向上
- 最大30%の応答品質改善が可能

**2. 拡張思考（Extended Thinking）:**
- 一般的な指示から始め、必要に応じて詳細化
- マルチショットプロンプティングとの併用が効果的
- 自己検証機能で精度とエラー処理を改善
- 思考バジェットは最小値（1,024トークン）から開始

これらの技術を組み合わせることで、複雑でデータ量の多いタスクに対して、より高い精度と効率で取り組むことができます。

---

## 次のステップ

- **実践**: 自分のユースケースで長文コンテキストと拡張思考を試す
- **最適化**: 思考バジェットを調整して最適な設定を見つける
- **組み合わせ**: 他のプロンプティング技術（XMLタグ、マルチショットなど）と併用
- **測定**: パフォーマンスを測定し、継続的に改善

---

## 参考リソース

- [Extended Thinking Cookbook](https://github.com/anthropics/anthropic-cookbook/tree/main/extended_thinking) - 拡張思考の実践例
- [Extended Thinking実装ガイド](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking) - 技術的な実装詳細
- [バッチ処理](https://docs.anthropic.com/en/docs/build-with-claude/batch-processing) - 大規模な思考バジェット向け
- [多言語サポート](https://docs.anthropic.com/en/docs/build-with-claude/multilingual-support) - サポートされる言語一覧
- [Chain-of-Thoughtプロンプティング](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/chain-of-thought) - 標準モードでの思考技術
