# 思考と構造化テクニック

## 概要
このドキュメントでは、Claudeのパフォーマンスを最大化するための中級レベルのプロンプト技術を解説します。複雑なタスクに対して、Claudeに「考える時間」を与えたり、役割を与えたり、応答を事前制御したり、プロンプトを連鎖させることで、より正確で一貫性のある高品質な出力を得ることができます。

## 目次
- [Chain of Thought（思考の連鎖）](#chain-of-thought思考の連鎖)
- [System Prompts（システムプロンプト）](#system-promptsシステムプロンプト)
- [Prefill Claude's Response（応答の先行入力）](#prefill-claudes-response応答の先行入力)
- [Chain Prompts（プロンプトの連鎖）](#chain-promptsプロンプトの連鎖)
- [まとめ](#まとめ)
- [参考リンク](#参考リンク)

---

## Chain of Thought（思考の連鎖）

### 説明
Chain of Thought (CoT) プロンプティングは、Claudeに問題を段階的に考えさせることで、パフォーマンスを劇的に向上させる技術です。研究、分析、問題解決などの複雑なタスクに直面した際、Claudeに「考える余地」を与えることで、より正確で洗練された出力が得られます。

### なぜ使うのか

**メリット:**
- **精度向上**: ステップバイステップで問題を解決することで、特に数学、論理、分析、複雑なタスクでのエラーが減少
- **一貫性**: 構造化された思考により、よりまとまりのある整理された応答が得られる
- **デバッグ**: Claudeの思考プロセスを見ることで、プロンプトの不明確な部分を特定できる

**使うべき場面:**
- 複雑な数学問題
- 多段階の分析
- 複雑な文書作成
- 多くの要素を考慮する意思決定

**使わない方が良い場面:**
- 出力が長くなることでレイテンシが増加する可能性がある
- 全てのタスクが深い思考を必要とするわけではない
- パフォーマンスとレイテンシのバランスを考慮して慎重に使用する

### 使い方

CoTテクニックは**複雑さの低い順**に並んでいます。複雑さが低い方法はコンテキストウィンドウのスペースを少なく使いますが、一般的にパワーも低くなります。

**重要なヒント**: 常にClaudeの思考を出力させること。思考プロセスを出力しなければ、思考は行われません！

#### 1. Basic Prompt（基本プロンプト）
プロンプトに「Think step-by-step（段階的に考えて）」を含める。

**特徴:**
- 最もシンプル
- *どのように*考えるべきかのガイダンスが欠けている
- アプリやユースケースに特化したタスクには不十分

#### 2. Guided Prompt（ガイド付きプロンプト）
Claudeが従うべき具体的なステップを示す。

**特徴:**
- より具体的な指示を提供
- 思考と回答を分離するための構造化が欠けている

#### 3. Structured Prompt（構造化プロンプト）
`<thinking>`や`<answer>`などのXMLタグを使用して、推論と最終回答を分離する。

**特徴:**
- 最もパワフル
- 思考プロセスと最終回答を明確に分離できる
- プログラムで処理しやすい

### 具体例

**Basic Prompt（基本プロンプト）:**
```
User: Calculate the total cost of 15 items at $23.50 each, with 8% tax. Think step-by-step.
```

Claudeは段階的に考えますが、どのように考えるべきかの指針は少ない。

**Guided Prompt（ガイド付きプロンプト）:**
```
User: Calculate the total cost of 15 items at $23.50 each, with 8% tax.

Follow these steps:
1. Calculate the subtotal
2. Calculate the tax amount
3. Add them together for the final total
```

より具体的な指示により、Claudeは構造化された方法で問題を解決します。

**Structured Prompt（構造化プロンプト）:**
```
User: Calculate the total cost of 15 items at $23.50 each, with 8% tax.

Put your reasoning in <thinking> tags and the final answer in <answer> tags.
```

XMLタグにより、思考プロセスと最終回答を明確に分離できます。

### ポイント・注意事項
- **思考を必ず出力させる**: 思考プロセスを出力しないと、思考は実際には行われない
- **タスクに応じて適切な方法を選ぶ**: シンプルなタスクには Basic、複雑なタスクには Structured
- **XMLタグで構造化**: `<thinking>`と`<answer>`タグを使うことで、プログラムでの処理が容易になる
- **レイテンシとのトレードオフ**: 詳細な思考は出力が長くなり、レイテンシが増加する可能性がある

---

## System Prompts（システムプロンプト）

### 説明
Claudeを使用する際、`system`パラメータを使用して役割を与えることで、パフォーマンスを劇的に向上させることができます。この技術は「ロールプロンプティング（Role Prompting）」として知られ、Claudeとシステムプロンプトを使う最も強力な方法です。

適切な役割により、Claudeは一般的なアシスタントから、あなたの専門分野のバーチャルエキスパートに変身します。

### なぜ使うのか

**メリット:**
- **精度の向上**: 法的分析や財務モデリングなどの複雑なシナリオで、ロールプロンプティングはClaudeのパフォーマンスを大幅に向上
- **トーンの調整**: CFOの簡潔さからコピーライターの魅力まで、ロールプロンプティングはClaudeのコミュニケーションスタイルを調整
- **フォーカスの改善**: 役割のコンテキストを設定することで、Claudeはタスクの特定要件の範囲内により留まる

### 使い方

Messages APIの`system`パラメータを使用してClaudeに役割を設定します：

```python
import anthropic

client = anthropic.Anthropic()
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=2048,
    system="You are a seasoned data scientist at a Fortune 500 company.",  # <-- ロールプロンプト
    messages=[
        {"role": "user", "content": "Analyze this dataset for anomalies: {{DATASET}}"}
    ]
)
print(response.content)
```

**ロールプロンプティングのヒント**: 役割を実験してみましょう！同じデータに対して、`data scientist`は`marketing strategist`とは異なる洞察を見るかもしれません。`Fortune 500企業の顧客インサイト分析を専門とするデータサイエンティスト`は、さらに異なる結果を生むかもしれません。

**システムプロンプトのヒント**: `system`パラメータはClaudeの役割を設定するために使用します。タスク固有の指示などは、代わりに`user`ターンに入れてください。

### 具体例

#### 例1: 法的契約分析

**役割なし:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=2048,
    messages=[
        {"role": "user", "content": "Review this contract for potential issues: {{CONTRACT}}"}
    ]
)
```

役割がない場合、Claudeは重要な問題を見逃す可能性があります。

**役割あり:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=2048,
    system="You are an experienced corporate attorney specializing in M&A contracts.",
    messages=[
        {"role": "user", "content": "Review this contract for potential issues: {{CONTRACT}}"}
    ]
)
```

役割を設定することで、Claudeは数百万ドルの損失につながる可能性のある重要な問題を捉えます。

#### 例2: 財務分析

**役割なし:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=2048,
    messages=[
        {"role": "user", "content": "Analyze Q4 financial performance: {{DATA}}"}
    ]
)
```

役割がない場合、Claudeの分析は深さに欠けます。

**役割あり:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=2048,
    system="You are a Chief Financial Officer with 20 years of experience in tech startups.",
    messages=[
        {"role": "user", "content": "Analyze Q4 financial performance: {{DATA}}"}
    ]
)
```

役割を設定することで、Claudeは実行可能なインサイトを提供します。

### ポイント・注意事項
- **具体的な役割を設定**: 「データサイエンティスト」よりも「Fortune 500企業のベテランデータサイエンティスト」の方が効果的
- **専門性を明示**: 専門分野を指定することで、より正確な分析が可能に
- **system パラメータを活用**: 役割は`system`に、タスクは`user`メッセージに分離する
- **実験を重ねる**: 同じタスクでも、異なる役割設定で結果が大きく変わる可能性がある

---

## Prefill Claude's Response（応答の先行入力）

### 説明
Claudeを使用する際、`Assistant`メッセージを先行入力（プリフィル）することで、応答を誘導する独自の機能があります。この強力な技術により、Claudeの行動を指示したり、前置きをスキップしたり、JSONやXMLなどの特定フォーマットを強制したり、ロールプレイシナリオでキャラクターの一貫性を維持することができます。

Claudeが期待通りに動作しない場合、数文のプリフィルでClaudeのパフォーマンスを大幅に改善できることがあります。少しのプリフィルで大きな効果があります！

**注意**: プリフィルは拡張思考モード（extended thinking）では現在サポートされていません。通常モードでのみ使用可能です。

### なぜ使うのか

**メリット:**
- **出力フォーマットの制御**: JSONやXMLなど特定のフォーマットを強制
- **前置きのスキップ**: 不要な導入文をスキップして、直接本題に入る
- **キャラクターの維持**: ロールプレイで一貫性を保つ
- **応答の方向性制御**: 応答の開始部分を制御することで、全体の方向性を誘導

### 使い方

`Assistant`メッセージに希望する初期テキストを含めてプリフィルします（Claudeの応答は`Assistant`メッセージが終わった場所から続きます）：

```python
import anthropic

client = anthropic.Anthropic()
response = client.messages.create(
    model="claude-sonnet-4-5",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": "What is your favorite color?"},
        {"role": "assistant", "content": "As an AI assistant, I don't have a favorite color, But if I had to pick, it would be green because"}  # プリフィルはここ
    ]
)
```

**重要**: プリフィルの内容は末尾に空白を含めることができません。`"As an AI assistant, I "`（最後にスペースあり）のようなプリフィルはエラーになります。

### 具体例

#### 例1: 出力フォーマットの制御と前置きのスキップ

**プリフィルなし:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": "Extract the name and email from: John Doe (john@example.com). Output in JSON."}
    ]
)
```

Claudeは前置きを含めて応答する可能性があります：
```
Here's the information in JSON format:
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

**プリフィルあり:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": "Extract the name and email from: John Doe (john@example.com). Output in JSON."},
        {"role": "assistant", "content": "{"}  # '{' でプリフィル
    ]
)
```

Claudeは前置きをスキップして直接JSONを出力：
```json
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

**パワーユーザーのヒント**: `{`でプリフィルすることで、Claudeに前置きをスキップさせ、直接JSONオブジェクトを出力させることができます。これはよりクリーンで簡潔で、プログラムが追加処理なしで解析しやすくなります。

**注意**: 特定のスキーマに準拠した保証されたJSON出力には、プリフィルの代わりに[Structured Outputs](https://docs.anthropic.com/claude/docs/structured-outputs)の使用を検討してください。Structured OutputsはClaudeの応答が常に定義したJSONスキーマに一致することを保証し、厳密なフォーマット準拠が必要な本番アプリケーションに最適です。

#### 例2: ロールプレイシナリオでのキャラクター維持

**プリフィルあり:**
```python
response = client.messages.create(
    model="claude-sonnet-4-5",
    max_tokens=1024,
    system="You are a pirate captain named Blackbeard.",
    messages=[
        {"role": "user", "content": "Tell me about your ship."},
        {"role": "assistant", "content": "[BLACKBEARD]:"}  # 役割名でプリフィル
    ]
)
```

`[ROLE_NAME]`をプリフィルすることで、長く複雑な会話でもClaudeにキャラクターを維持させることができます。これは`system`パラメータのロールプロンプティングと組み合わせると特に強力です。

### ポイント・注意事項
- **末尾空白に注意**: プリフィルの内容は末尾に空白を含めることができない
- **`{`でJSON出力を強制**: 前置きをスキップして直接JSON出力を得られる
- **ロールプレイには`[ROLE_NAME]:`**: キャラクターの一貫性を長い会話でも維持
- **Structured Outputsも検討**: 厳密なJSON スキーマが必要な場合は専用機能を使用
- **少量のプリフィルで大きな効果**: 数文字から数文のプリフィルで動作を大きく変えられる
- **拡張思考モードでは未対応**: 現在は通常モードでのみ使用可能

---

## Chain Prompts（プロンプトの連鎖）

### 説明
複雑なタスクに取り組む際、単一のプロンプトで全てを処理しようとすると、Claudeが時々失敗することがあります。Chain of Thought (CoT) プロンプティングは優れていますが、各ステップが深い思考を必要とする複数の異なるステップがあるタスクの場合はどうでしょうか？

ここで登場するのがプロンプトチェーニング（Prompt Chaining）です：複雑なタスクを、より小さく管理可能なサブタスクに分割します。

### なぜ使うのか

**メリット:**
1. **精度**: 各サブタスクがClaudeの完全な注意を受けるため、エラーが減少
2. **明確性**: よりシンプルなサブタスクは、より明確な指示と出力を意味する
3. **トレーサビリティ**: プロンプトチェーン内の問題を簡単に特定して修正できる

### いつ使うか

以下のような多段階タスクにプロンプトチェーニングを使用します：
- 研究の統合
- ドキュメント分析
- 反復的なコンテンツ作成

タスクが複数の変換、引用、または指示を含む場合、チェーニングによってClaudeがステップを落としたり誤って処理したりすることを防ぎます。

**重要**: チェーン内の各リンクがClaudeの完全な注意を受けます！

**デバッグのヒント**: Claudeがステップを見逃したりパフォーマンスが悪い場合、そのステップを独自のプロンプトに分離してください。これにより、タスク全体をやり直すことなく、問題のあるステップを微調整できます。

### 使い方

1. **サブタスクを特定**: タスクを明確で連続的なステップに分割
2. **XMLで構造化して明確な受け渡し**: XMLタグを使用してプロンプト間で出力を渡す
3. **単一タスクの目標**: 各サブタスクは単一の明確な目的を持つべき
4. **反復**: Claudeのパフォーマンスに基づいてサブタスクを改善

### チェーニングされたワークフローの例

**多段階分析:**
- 法的分析および業務分析（下記の例を参照）

**コンテンツ作成パイプライン:**
- 研究 → アウトライン → ドラフト → 編集 → フォーマット

**データ処理:**
- 抽出 → 変換 → 分析 → 可視化

**意思決定:**
- 情報収集 → オプションのリスト化 → 各オプションの分析 → 推奨

**検証ループ:**
- コンテンツ生成 → レビュー → 改善 → 再レビュー

**最適化のヒント**: 独立したサブタスク（複数のドキュメントの分析など）を持つタスクの場合、別々のプロンプトを作成し、それらを並列で実行してスピードアップします。

### 具体例

#### 例1: 法的文書分析チェーン

**ステップ1: 重要条項の抽出**
```
User: Extract all clauses related to payment terms, liability, and termination from this contract:

<contract>
{{CONTRACT_TEXT}}
</contract>

Put each type of clause in separate XML tags: <payment_terms>, <liability>, <termination>
```

**ステップ2: 抽出した条項の分析**
```
User: Analyze these contract clauses for potential risks:

<payment_terms>
{{OUTPUT_FROM_STEP_1}}
</payment_terms>

<liability>
{{OUTPUT_FROM_STEP_1}}
</liability>

<termination>
{{OUTPUT_FROM_STEP_1}}
</termination>

For each section, identify risks and rate severity (low/medium/high).
```

**ステップ3: 推奨事項の生成**
```
User: Based on this risk analysis, provide specific recommendations:

<risk_analysis>
{{OUTPUT_FROM_STEP_2}}
</risk_analysis>

For each high or medium severity risk, suggest specific contract language changes.
```

#### 例2: ビジネスレポート作成チェーン

**ステップ1: データ抽出**
```
User: Extract key metrics from this quarterly report:

<report>
{{REPORT_DATA}}
</report>

Focus on revenue, expenses, and growth rates. Output in <metrics> tags.
```

**ステップ2: トレンド分析**
```
User: Analyze these metrics for trends:

<metrics>
{{OUTPUT_FROM_STEP_1}}
</metrics>

Compare to previous quarters and identify significant changes.
```

**ステップ3: エグゼクティブサマリー作成**
```
User: Create an executive summary based on this analysis:

<trend_analysis>
{{OUTPUT_FROM_STEP_2}}
</trend_analysis>

Write in a concise, business-appropriate tone. Limit to 200 words.
```

### 高度な技術: セルフコレクションチェーン

Claudeに自分自身の作業をレビューさせるためにプロンプトをチェーンできます！これによりエラーを捕捉し、出力を改善できます。特に重要なタスクに有効です。

**例: セルフレビューチェーン**

**ステップ1: 初期応答の生成**
```
User: Write a product description for a new smartphone.
```

**ステップ2: 自己レビュー**
```
User: Review this product description for clarity, accuracy, and persuasiveness:

<description>
{{OUTPUT_FROM_STEP_1}}
</description>

Identify specific areas for improvement.
```

**ステップ3: 改善版の作成**
```
User: Revise the product description based on this review:

<original>
{{OUTPUT_FROM_STEP_1}}
</original>

<review>
{{OUTPUT_FROM_STEP_2}}
</review>

Create an improved version addressing all feedback.
```

### ポイント・注意事項
- **タスクを小さく分割**: 複雑なタスクは小さく管理可能なサブタスクに
- **XMLタグで構造化**: プロンプト間の受け渡しを明確にする
- **各ステップに単一の目標**: 各プロンプトは一つの明確な目的を持つ
- **並列実行で高速化**: 独立したサブタスクは並列で実行可能
- **セルフレビューループ**: Claudeに自分の作業をレビューさせて品質向上
- **デバッグが容易**: 問題のあるステップだけを個別に修正できる
- **トレーサビリティ**: 各ステップの入出力が明確で、問題箇所を特定しやすい

---

## まとめ

この文書では、Claudeのパフォーマンスを最大化する4つの中級テクニックを学びました：

1. **Chain of Thought (CoT)**: 複雑な問題を段階的に考えさせることで精度と一貫性を向上
   - Basic、Guided、Structured の3つのレベル
   - XMLタグで思考と回答を分離

2. **System Prompts**: `system`パラメータでClaudeに役割を与えることで専門性を向上
   - 精度、トーン、フォーカスの改善
   - 具体的で詳細な役割設定が効果的

3. **Prefill**: `Assistant`メッセージの先行入力で出力を制御
   - JSON/XML形式の強制
   - 前置きのスキップ
   - ロールプレイでのキャラクター維持

4. **Chain Prompts**: 複雑なタスクを複数のサブタスクに分割
   - 精度、明確性、トレーサビリティの向上
   - セルフレビューループで品質改善
   - 並列実行で効率化

これらの技術を組み合わせることで、より高度で信頼性の高いAIアプリケーションを構築できます。

---

## 参考リンク

### 公式ドキュメント
- [Chain of Thought](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/chain-of-thought)
- [System Prompts](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/system-prompts)
- [Prefill Claude's Response](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/prefill-claudes-response)
- [Chain Prompts](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/chain-prompts)

### チュートリアル
- [GitHub プロンプトエンジニアリングチュートリアル](https://github.com/anthropics/prompt-eng-interactive-tutorial)
- [Google Sheets プロンプトエンジニアリングチュートリアル](https://docs.google.com/spreadsheets/d/19jzLgRruG9kjUQNKtCg1ZjdD6l6weA6qRXG5zLIAhC8)

### 関連リソース
- [Working with Messages](https://platform.claude.com/docs/en/build-with-claude/working-with-messages)
- [Structured Outputs](https://platform.claude.com/docs/en/build-with-claude/structured-outputs)
- [Prompt Library](https://platform.claude.com/docs/en/resources/prompt-library/library)
- [Extended Thinking Tips](https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/extended-thinking-tips)
